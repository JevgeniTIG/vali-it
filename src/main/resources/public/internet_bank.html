<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Internet Bank</title>
    <link rel="stylesheet" href="styles.css">


</head>
<body>
<img src="mrb_header.jpg" width="1200" height="120">

<h5>
</h5>
<form>
    <!Welcomes customer>
    <span id="helloMessage"></span>
    <span style="padding-left:800px"></span>
    <input class="button-function" type="button" id="logOut" onclick="location.href='index.html'"
           value="Log Out" style="height:20px;width=60px">
</form>

<h5>
</h5>
<table>
<tr>
    <!Gets account balance of current user>
    <td><input class="button-function" type="button" id="getBalance" value="Show Balance"></td>
    <td><input type="text" id="yourBalanceOutput"></td>
</tr>


<tr>
    <!Transfers money between accounts>
    <td><input class="button-function" type="button" id="transferButton" value="Transfer"></td>
    <td><input type="text" id="accountFrom" placeholder="Payer's account"></td>
    <td><input type="text" id="accountTo" placeholder="Receiver's account"></td>
    <td><input type="text" id="amountToTransfer" placeholder="Amount"></td>
</tr>
<tr>
    <!Shows account balance>
    <td><input class="button-function" type="button" id="statementButton" value="Show Statement"></td>

</tr>
<tr><div id="adminMode"></div></tr>
</table>

<div id="tableOfTransactions"></div>

</body>

<script>


    // Welcomes customer

        fetch('/welcome_user', {
            method: 'POST',
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json'
            }
            })
        .then(function (response) {
            return response.json();
        })
        .then(function (jsonData) {
            var html = '<span>';
			for (var i = 0; i < jsonData.length; ++i) {
				var item = jsonData[i];
                html += item.firstName;
                html += ' ';
                html += item.lastName;
                html += '!';
            }
            html += '</span>'
            helloMessage.innerHTML = 'Welcome, ' + html;

        })


        .catch(function (err) {
            console.log(err);
            alert('oops');
        });



    // Gets balance of specified account
    let submitButton = document.getElementById("getBalance")
    submitButton.addEventListener('click', function getBalance() {

        fetch('/getbalance_logged_user', {
            method: 'POST',
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json'
            }
            })

        .then(function (response) {
            return response.json();
        })
        .then(function (jsonData) {
            yourBalanceOutput.value = jsonData;

        })
        .catch(function (err) {
            yourBalanceOutput.value = 'Error';
        });
    });



    // Transfers money between accounts
    let transferButton = document.getElementById("transferButton")
    transferButton.addEventListener('click', function transferAccount() {

        fetch('/transfer_efficient', {
            method: 'PUT',
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json'
            },
				body: JSON.stringify({
					accountFrom: accountFrom.value,
					accountTo: accountTo.value,
					amount: amountToTransfer.value

				})
            })

        .then(function (response) {
            transferButton.value = 'Transaction complete';
            accountFrom.value = ' ';
            accountTo.value = ' ';
            amountToTransfer.value = ' ';
        })

        .catch(function (err) {
            transferButton.value = 'You are trying to access classified data';
        });

    });


// Shows account statement
    let statementButton = document.getElementById("statementButton")
    statementButton.addEventListener('click', function showStatement() {

        fetch('/showstatement_logged_user', {
            method: 'POST',
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json'
            }
            })

        .then(function (response) {
            return response.json();
        })

        .then(function (jsonData) {

            var html = '<table>';
			html += '<tr>';
            html += '<td><b>ACCOUNT</b></td>';
            html += '<td><b>DEPOSIT</b></td>';
            html += '<td><b>WITHDRAW</b></td>';
            html += '<td><b>BALANCE</b></td>';
			html += '</tr>';
			for (var i = 0; i < jsonData.length; ++i) {
				var item = jsonData[i];
			    html += '<tr>';
                html += '<td>'+item.account+'</td>';
                if(item.deposit == null){
                    html += '<td></td>';
                } else {
                    html += '<td>'+item.deposit+'</td>';
                }
                if(item.withdraw == null){
                    html += '<td></td>';
                } else {
                    html += '<td>'+item.withdraw+'</td>';
                }
                html += '<td>'+item.balance+'</td>';
                html += '</tr>';
			}
			html += '</table>';
			tableOfTransactions.innerHTML = html;

        })
        .catch(function (err) {
            alert('Error');
        });

    });




    // Checks if admin is currently logged in. If yes >>> changes interface and functionality of internet bank page

        // Adds a button to register new customer
    fetch('/username', {
        method: 'GET',
        cache: 'no-cache',
        headers: {
            'Content-Type': 'application/json'
        }
        })

    .then(function (response) {
        return response.text();
    })
    .then(function (jsonData) {

        if (jsonData =='admin'){
            registerNewCustomer();
            proceedToInternetBankAdmin();

            //adminMode.innerHTML = html;
           }


    })
    .catch(function (err) {
        alert('Error');
    });

    function registerNewCustomer(){
        var button = document.createElement("button");
        button.innerHTML = "Register new customer";

        var body = document.getElementsByTagName("body")[0];
        body.appendChild(button);


        button.addEventListener ("click", function common(){
        location.href= "register.html"
        //adminMode.innerHTML = body;
        });
    }

    function proceedToInternetBankAdmin(){
        var button = document.createElement("button");
        button.innerHTML = "Proceed to admin mode";

        var body = document.getElementsByTagName("body")[0];
        body.appendChild(button);


        button.addEventListener ("click", function common(){
        location.href= "internet_bank_admin.html"

        });
    }



</script>
</html>